<!DOCTYPE html>
<html lang="nl" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SV1657-modernisatie (vergelijking) - Dark Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
      }
    </script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Inter:wght@400;500;700&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Frank+Ruhl+Libre:wght@400;700&display=swap');

      body {
        font-family: 'Roboto', 'Inter', sans-serif;
      }

      /* Kopjes: Roboto */
      h1, h2, h3, h4, h5, h6 {
        font-family: 'Roboto', 'Inter', sans-serif;
      }

      /* Lopende tekst: Libre Baskerville */
      .verse-main-text p {
        font-family: 'Libre Baskerville', Georgia, serif;
        line-height: 1.6;
      }

      .verse-references-block {
        font-family: 'Libre Baskerville', Georgia, serif;
      }

      .intro-text, .epilogue-text {
        font-family: 'Libre Baskerville', Georgia, serif;
      }

      /* Hebreeuwse tekst: Frank Ruhl Libre */
      .hebrew-text {
        font-family: 'Frank Ruhl Libre', 'SBL Hebrew', serif;
        direction: rtl;
        line-height: 1.8;
        font-size: 1.125rem; /* 18px - groter voor Hebreeuws */
      }

      /* Griekse tekst */
      .greek-text {
        font-family: 'Frank Ruhl Libre', serif;
        line-height: 1.7;
        font-size: 0.875rem; /* 14px - kleiner voor Grieks */
      }

      /* UI-elementen: Roboto/Inter */
      button, label, input, select, textarea {
        font-family: 'Roboto', 'Inter', sans-serif;
      }

      sup {
        line-height: 0;
        position: relative;
        vertical-align: baseline;
        top: -0.5em;
        font-size: 0.75em;
        padding: 0 0.1em;
        color: #f97316;
      }
      .font-bold sup {
        font-weight: normal;
      }

      /* table cells stay top-aligned */
      .verse-row td:nth-child(2),
      .verse-row td:nth-child(3) {
        vertical-align: top;
      }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useMemo, useEffect, useRef } = React;

        /* ================= Bible Books Data (66 books) ================= */

        const BIBLE_BOOKS = [
          // Oude Testament (39 boeken)
          //{ abbr: 'GEN', name: 'Genesis', chapters: 50 },
          //{ abbr: 'EXO', name: 'Exodus', chapters: 40 },
          //{ abbr: 'LEV', name: 'Leviticus', chapters: 27 },
          //{ abbr: 'NUM', name: 'Numeri', chapters: 36 },
          //{ abbr: 'DEU', name: 'Deuteronomium', chapters: 34 },
          //{ abbr: 'JOS', name: 'Jozua', chapters: 24 },
          //{ abbr: 'JDG', name: 'Rechters', chapters: 21 },
          //{ abbr: 'RUT', name: 'Ruth', chapters: 4 },
          //{ abbr: '1SA', name: '1 Samuël', chapters: 31 },
          { abbr: '1SA', name: '1 Samuël', chapters: 3 },
          //{ abbr: '2SA', name: '2 Samuël', chapters: 24 },
          //{ abbr: '1KI', name: '1 Koningen', chapters: 22 },
          //{ abbr: '2KI', name: '2 Koningen', chapters: 25 },
          //{ abbr: '1CH', name: '1 Kronieken', chapters: 29 },
          //{ abbr: '2CH', name: '2 Kronieken', chapters: 36 },
          //{ abbr: 'EZR', name: 'Ezra', chapters: 10 },
          //{ abbr: 'NEH', name: 'Nehemia', chapters: 13 },
          //{ abbr: 'EST', name: 'Esther', chapters: 10 },
          //{ abbr: 'JOB', name: 'Job', chapters: 42 },
          //{ abbr: 'PSA', name: 'Psalmen', chapters: 150 },
          //{ abbr: 'PRO', name: 'Spreuken', chapters: 31 },
          //{ abbr: 'ECC', name: 'Prediker', chapters: 12 },
          //{ abbr: 'SNG', name: 'Hooglied', chapters: 8 },
          //{ abbr: 'ISA', name: 'Jesaja', chapters: 66 },
          //{ abbr: 'JER', name: 'Jeremia', chapters: 52 },
          //{ abbr: 'LAM', name: 'Klaagliederen', chapters: 5 },
          //{ abbr: 'EZK', name: 'Ezechiël', chapters: 48 },
          //{ abbr: 'DAN', name: 'Daniël', chapters: 12 },
          //{ abbr: 'HOS', name: 'Hosea', chapters: 14 },
          //{ abbr: 'JOL', name: 'Joël', chapters: 3 },
          //{ abbr: 'AMO', name: 'Amos', chapters: 9 },
          //{ abbr: 'OBA', name: 'Obadja', chapters: 1 },
          //{ abbr: 'JON', name: 'Jona', chapters: 4 },
          //{ abbr: 'MIC', name: 'Micha', chapters: 7 },
          { abbr: 'MIC', name: 'Micha', chapters: 2 },
          //{ abbr: 'NAM', name: 'Nahum', chapters: 3 },
          //{ abbr: 'HAB', name: 'Habakuk', chapters: 3 },
          //{ abbr: 'ZEP', name: 'Zefanja', chapters: 3 },
          //{ abbr: 'HAG', name: 'Haggaï', chapters: 2 },
          //{ abbr: 'ZEC', name: 'Zacharia', chapters: 14 },
          //{ abbr: 'MAL', name: 'Maleachi', chapters: 4 },
          // Nieuwe Testament (27 boeken)
          //{ abbr: 'MAT', name: 'Mattheüs', chapters: 28 },
          { abbr: 'MRK', name: 'Markus', chapters: 16 },
          //{ abbr: 'LUK', name: 'Lukas', chapters: 24 },
          //{ abbr: 'JHN', name: 'Johannes', chapters: 21 },
          //{ abbr: 'ACT', name: 'Handelingen', chapters: 28 },
          //{ abbr: 'ROM', name: 'Romeinen', chapters: 16 },
          //{ abbr: '1CO', name: '1 Korinthe', chapters: 16 },
          //{ abbr: '2CO', name: '2 Korinthe', chapters: 13 },
          //{ abbr: 'GAL', name: 'Galaten', chapters: 6 },
          //{ abbr: 'EPH', name: 'Efeziërs', chapters: 6 },
          //{ abbr: 'PHP', name: 'Filippenzen', chapters: 4 },
          //{ abbr: 'COL', name: 'Kolossenzen', chapters: 4 },
          //{ abbr: '1TH', name: '1 Thessalonicenzen', chapters: 5 },
          //{ abbr: '2TH', name: '2 Thessalonicenzen', chapters: 3 },
          //{ abbr: '1TI', name: '1 Timotheüs', chapters: 6 },
          //{ abbr: '2TI', name: '2 Timotheüs', chapters: 4 },
          //{ abbr: 'TIT', name: 'Titus', chapters: 3 },
          //{ abbr: 'PHM', name: 'Filemon', chapters: 1 },
          //{ abbr: 'HEB', name: 'Hebreeën', chapters: 13 },
          //{ abbr: 'JAS', name: 'Jakobus', chapters: 5 },
          //{ abbr: '1PE', name: '1 Petrus', chapters: 5 },
          //{ abbr: '2PE', name: '2 Petrus', chapters: 3 },
          { abbr: '1JN', name: '1 Johannes', chapters: 5 },
          //{ abbr: '2JN', name: '2 Johannes', chapters: 1 },
          //{ abbr: '3JN', name: '3 Johannes', chapters: 1 },
          //{ abbr: 'JUD', name: 'Judas', chapters: 1 },
          //{ abbr: 'REV', name: 'Openbaring', chapters: 22 },
        ];

        //const OT_BOOKS = BIBLE_BOOKS.slice(0, 39);
        //const NT_BOOKS = BIBLE_BOOKS.slice(39);

        const OT_BOOKS = BIBLE_BOOKS.slice(0, 2);
        const NT_BOOKS = BIBLE_BOOKS.slice(2);

        /* ================= Icons ================= */

        const ThumbUpIcon = ({ className }) => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            className={className}
            viewBox="0 0 20 20"
            fill="currentColor"
            aria-hidden="true"
          >
            <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.563 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.821 2.311l-1.077 1.542A4 4 0 006 10.333z" />
          </svg>
        );

        const ThumbDownIcon = ({ className }) => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            className={className}
            viewBox="0 0 20 20"
            fill="currentColor"
            aria-hidden="true"
          >
            <path d="M18 9.5a1.5 1.5 0 11-3 0v-6a1.5 1.5 0 013 0v6zM14 9.667v-5.43a2 2 0 00-1.106-1.79l-.05-.025A4 4 0 0011.057 2H5.642a2 2 0 00-1.962 1.608l-1.2 6A2 2 0 004.437 12H8v4a2 2 0 002 2 1 1 0 001-1v-.667a4 4 0 01.821-2.311l1.077-1.542A4 4 0 0014 9.667z" />
          </svg>
        );

        const InfoIcon = ({ className }) => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            className={className}
            viewBox="0 0 24 24"
            fill="currentColor"
            aria-hidden="true"
          >
            <circle cx="12" cy="12" r="10" />
            <line x1="12" y1="16" x2="12" y2="12" stroke="white" strokeWidth="2" strokeLinecap="round" />
            <circle cx="12" cy="8" r="1" fill="white" />
          </svg>
        );

        const MoonIcon = ({ className }) => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            className={className}
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
          </svg>
        );

        const SunIcon = ({ className }) => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            className={className}
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path fillRule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clipRule="evenodd" />
          </svg>
        );

        /* ================= Book/Chapter Selector ================= */

        const BookChapterSelector = ({ onLoad, currentBook, currentChapter, loading }) => {
          const [selectedBook, setSelectedBook] = useState(currentBook || '1JN');
          const [selectedChapter, setSelectedChapter] = useState(currentChapter || 1);

          const selectedBookData = useMemo(() =>
            BIBLE_BOOKS.find(b => b.abbr === selectedBook) || BIBLE_BOOKS.find(b => b.abbr === '1JN'),
            [selectedBook]
          );

          const chapters = useMemo(() =>
            Array.from({ length: selectedBookData.chapters }, (_, i) => i + 1),
            [selectedBookData]
          );

          useEffect(() => {
            if (selectedChapter > selectedBookData.chapters) {
              setSelectedChapter(1);
            }
          }, [selectedBook, selectedBookData.chapters, selectedChapter]);

          useEffect(() => {
            setSelectedBook(currentBook);
            setSelectedChapter(currentChapter);
          }, [currentBook, currentChapter]);

          const handleLoad = useCallback(() => {
            onLoad(selectedBook, selectedChapter);
          }, [onLoad, selectedBook, selectedChapter]);

          return (
            <div className="flex items-center gap-2 flex-wrap">
              <select
                value={selectedBook}
                onChange={(e) => {
                  setSelectedBook(e.target.value);
                  setSelectedChapter(1);
                }}
                className="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-sky-500 focus:border-sky-500 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200"
              >
                <optgroup label="Oude Testament">
                  {OT_BOOKS.map(book => (
                    <option key={book.abbr} value={book.abbr}>
                      {book.name}
                    </option>
                  ))}
                </optgroup>
                <optgroup label="Nieuwe Testament">
                  {NT_BOOKS.map(book => (
                    <option key={book.abbr} value={book.abbr}>
                      {book.name}
                    </option>
                  ))}
                </optgroup>
              </select>

              <select
                value={selectedChapter}
                onChange={(e) => setSelectedChapter(parseInt(e.target.value))}
                className="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-sky-500 focus:border-sky-500 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 w-20"
              >
                {chapters.map(ch => (
                  <option key={ch} value={ch}>
                    {ch}
                  </option>
                ))}
              </select>

              <button
                onClick={handleLoad}
                disabled={loading}
                className="px-4 py-2 text-sm font-medium text-white bg-sky-600 rounded-md hover:bg-sky-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500"
              >
                {loading ? 'Laden...' : 'Laden'}
              </button>
            </div>
          );
        };

        /* ================= Header ================= */

        const Header = ({ fileName, onDownload, hasRatings, onLoadNew, onLoadBookChapter, currentBook, currentChapter, loading, darkMode, toggleDarkMode }) => {
          return (
            <header className="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm sticky top-0 z-10 w-full border-b border-gray-200 dark:border-gray-700">
              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div className="flex items-center justify-between h-16">
                  <div className="flex items-center gap-4 flex-wrap">
                    <h1 className="text-xl font-bold text-sky-600 dark:text-sky-400">
                      SV1657-modernisatie
                    </h1>
                    <BookChapterSelector
                      onLoad={onLoadBookChapter}
                      currentBook={currentBook}
                      currentChapter={currentChapter}
                      loading={loading}
                    />
                  </div>
                  <div className="flex items-center space-x-4">
                    {fileName && (
                      <button
                        onClick={onLoadNew}
                        className="px-4 py-2 text-sm font-medium text-gray-800 dark:text-gray-200 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 dark:focus:ring-offset-gray-800 focus:ring-gray-400"
                      >
                        Nieuw Bestand
                      </button>
                    )}
                    <button
                      onClick={onDownload}
                      disabled={!hasRatings}
                      className="px-4 py-2 text-sm font-medium text-white bg-sky-600 rounded-md hover:bg-sky-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 dark:focus:ring-offset-gray-800 focus:ring-sky-500"
                    >
                      Beoordelingen Downloaden
                    </button>
                    <button
                      onClick={toggleDarkMode}
                      className="p-2 text-gray-600 dark:text-gray-300 hover:text-sky-600 dark:hover:text-sky-400 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 rounded-md"
                      aria-label="Toggle dark mode"
                      title={darkMode ? 'Lichte modus' : 'Donkere modus'}
                    >
                      {darkMode ? (
                        <SunIcon className="w-6 h-6" />
                      ) : (
                        <MoonIcon className="w-6 h-6" />
                      )}
                    </button>
                    <a
                      href="https://github.com/wmotte/sv1657_pilot"
                      target="_blank"
                      rel="noopener noreferrer"
                      className="p-2 text-sky-600 dark:text-sky-400 hover:text-sky-700 dark:hover:text-sky-300 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 rounded-md"
                      aria-label="Informatie"
                      title="Meer informatie"
                    >
                      <InfoIcon className="w-6 h-6" />
                    </a>
                  </div>
                </div>
              </div>
            </header>
          );
        };

        /* ================= File Upload ================= */

        const FileUpload = ({ onFileUpload, setFileName }) => {
          const handleFileChange = useCallback((event) => {
            const file = event.target.files?.[0];
            if (file) {
              setFileName(file.name);
              const reader = new FileReader();
              reader.onload = (e) => {
                try {
                  const content = e.target?.result;
                  if (typeof content === 'string') {
                    const data = JSON.parse(content);
                    onFileUpload(data);
                  }
                } catch (error) {
                  console.error("Fout bij het parsen van JSON:", error);
                  alert("Ongeldig JSON-bestand.");
                }
              };
              reader.readAsText(file);
            }
          }, [onFileUpload, setFileName]);

          return (
            <div className="w-full flex justify-center p-8 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-750 transition-colors">
              <label htmlFor="file-upload" className="cursor-pointer flex flex-col items-center text-center">
                <svg xmlns="http://www.w3.org/2000/svg" className="w-12 h-12 text-gray-400 dark:text-gray-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <span className="text-lg font-semibold text-sky-600 dark:text-sky-400">Kies een bestand</span>
                <span className="mt-1 text-sm text-gray-500 dark:text-gray-400">of sleep het hierheen</span>
                <span className="mt-1 text-xs text-gray-400 dark:text-gray-500">JSON-formaat vereist</span>
              </label>
              <input
                id="file-upload"
                type="file"
                accept=".json"
                className="hidden"
                onChange={handleFileChange}
              />
            </div>
          );
        };

        /* ================= Helpers ================= */

        // Turn $...$ and <...> markers into <sup>1</sup> etc. and collect notes
        const parseTextWithMarkers = (text) => {
            if (!text) return { textWithMarkers: '', references: [], annotations: [] };

            let counter = 0;
            const references = [];
            const annotations = [];

            // $...$   -> reference
            // <...>   -> annotation
            const regex = /(\$(.*?)\$)|(<(.*?)>)/g;

            let lastIndex = 0;
            const parts = [];

            let match;
            while ((match = regex.exec(text)) !== null) {
              parts.push(text.substring(lastIndex, match.index));

              counter++;
              const refContent = match[2];
              const noteContent = match[4];

              if (refContent !== undefined) {
                references.push({ id: counter, content: refContent.trim() });
              } else if (noteContent !== undefined) {
                const processedNote = noteContent.trim().replace(/\$(.*?)\$/g, '«$1»');
                annotations.push({ id: counter, content: processedNote });
              }

              parts.push(`<sup>${counter}</sup>`);

              lastIndex = regex.lastIndex;

              // Skip a single space after the marker if present
              if (lastIndex < text.length && text[lastIndex] === ' ') {
                lastIndex++;
              }
            }

            parts.push(text.substring(lastIndex));

            const textWithMarkers = parts.join('');

            return { textWithMarkers, references, annotations };
        };

        /* ================= TextContent =================
           mainRef: ref to the main verse text block
           offsetTopPx: how much to push the Kanttekeningen block down
        =================================================*/
        const TextContent = ({
          textWithMarkers,
          references,
          annotations,
          className,
          mainRef,
          offsetTopPx
        }) => {

          const hasNotesOrRefs = references.length > 0 || annotations.length > 0;
          const hasBoth = references.length > 0 && annotations.length > 0;

          const combinedItems = hasBoth
            ? [...references, ...annotations].sort((a, b) => a.id - b.id)
            : null;

          return (
            <div>
              {/* main text */}
              <div className="verse-main-text" ref={mainRef}>
                <p
                  className={className}
                  dangerouslySetInnerHTML={{ __html: textWithMarkers }}
                />
              </div>

              {/* kanttekeningen / verwijzingen */}
              {hasNotesOrRefs && (
                <div
                  className="verse-references-block"
                  style={{
                    marginTop: (offsetTopPx ?? 0) + 16, // 16px == 1rem gap
                  }}
                >
                  {hasBoth ? (
                    <div>
                      <p className="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2 text-center">
                        Verwijzingen &amp; Kanttekeningen
                      </p>
                      <div className="space-y-1">
                        {combinedItems.map(item => (
                          <div
                            key={item.id}
                            className="flex items-start text-sm text-gray-600 dark:text-gray-300"
                          >
                            <span
                              className="w-3 flex-shrink-0 text-right mr-1"
                              style={{ color: '#f97316' }}
                            >
                              {item.id}
                            </span>
                            <span>{item.content}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  ) : (
                    <div className="flex flex-row gap-8">
                      {references.length > 0 && (
                        <div className="flex-1 min-w-0">
                          <p className="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2 text-center">
                            Verwijzingen
                          </p>
                          <div className="space-y-1">
                            {references.map(ref => (
                              <div
                                key={ref.id}
                                className="flex items-start text-sm text-gray-600 dark:text-gray-300"
                              >
                                <span
                                  className="w-3 flex-shrink-0 text-right mr-1"
                                  style={{ color: '#f97316' }}
                                >
                                  {ref.id}
                                </span>
                                <span>{ref.content}</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                      {annotations.length > 0 && (
                        <div className="flex-1 min-w-0">
                          <p className="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2 text-center">
                            Kanttekeningen
                          </p>
                          <div className="space-y-1">
                            {annotations.map(note => (
                              <div
                                key={note.id}
                                className="flex items-start text-sm text-gray-600 dark:text-gray-300"
                              >
                                <span
                                  className="w-3 flex-shrink-0 text-right mr-1"
                                  style={{ color: '#f97316' }}
                                >
                                  {note.id}
                                </span>
                                <span>{note.content}</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              )}
            </div>
          );
        };

        /* ================= FeedbackControls ================= */

        const FeedbackControls = ({ ratingData, onRatingChange, onCommentChange, className = '' }) => {
          const handleRating = (newRating) => {
            const currentRating = ratingData?.rating;
            onRatingChange(currentRating === newRating ? null : newRating);
          };

          return (
            <div className={`flex flex-col gap-2 ${className}`}>
              <div className="flex items-center space-x-2">
                <button
                  onClick={() => handleRating('up')}
                  className={`p-2 rounded-full transition-colors duration-200 ${
                    ratingData?.rating === 'up'
                      ? 'bg-green-500 text-white'
                      : 'bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400 hover:bg-green-100 dark:hover:bg-green-900'
                  }`}
                  aria-label="Geef een goede beoordeling"
                >
                  <ThumbUpIcon className="w-5 h-5" />
                </button>
                <button
                  onClick={() => handleRating('down')}
                  className={`p-2 rounded-full transition-colors duration-200 ${
                    ratingData?.rating === 'down'
                      ? 'bg-red-500 text-white'
                      : 'bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400 hover:bg-red-100 dark:hover:bg-red-900'
                  }`}
                  aria-label="Geef een slechte beoordeling"
                >
                  <ThumbDownIcon className="w-5 h-5" />
                </button>
              </div>
              <textarea
                value={ratingData?.comment || ''}
                onChange={onCommentChange}
                placeholder="Voeg een opmerking toe..."
                className="w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md p-2 text-sm text-gray-800 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition"
                rows={2}
              />
            </div>
          );
        };

        /* ================= VerseDisplay =================
           For each verse row:
           - measure both main text blocks
           - compute max height
           - push the references block in the *shorter* column down
        =================================================*/
        const VerseDisplay = ({ verse, ratingData, onRate, sourceLanguage }) => {
          const original = useMemo(() => parseTextWithMarkers(verse.original_text), [verse.original_text]);
          const final = useMemo(() => parseTextWithMarkers(verse.final_text), [verse.final_text]);

          // Detecteer of het Grieks of Hebreeuws is via regex
          const isGreek = /Grieks/i.test(sourceLanguage);
          const isHebrew = /Hebreeuws/i.test(sourceLanguage);

          const originalMainRef = useRef(null);
          const finalMainRef = useRef(null);

          const [offsets, setOffsets] = useState({ left: 0, right: 0 });

          useEffect(() => {
            const syncOffsets = () => {
              const hLeft = originalMainRef.current ? originalMainRef.current.offsetHeight : 0;
              const hRight = finalMainRef.current ? finalMainRef.current.offsetHeight : 0;
              const maxH = Math.max(hLeft, hRight);

              setOffsets({
                left: maxH - hLeft,
                right: maxH - hRight,
              });
            };

            // run now and whenever the window is resized (reflow might change line breaks)
            syncOffsets();
            window.addEventListener('resize', syncOffsets);
            return () => {
              window.removeEventListener('resize', syncOffsets);
            };
          }, []);

          const handleRatingChange = (rating) => {
            onRate(
              verse.verse_number,
              rating,
              ratingData?.comment || ''
            );
          };

          const handleCommentChange = (e) => {
            onRate(
              verse.verse_number,
              ratingData?.rating || null,
              e.target.value
            );
          };

          return (
            <tr className="verse-row hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors align-top">
              {/* verse number */}
              <td className="px-4 py-4 align-top text-left">
                <span className="text-2xl font-bold text-sky-600 dark:text-sky-400 font-sans">
                  {verse.verse_number}
                </span>
              </td>

              {/* left column (Statenvertaling 1657) */}
              <td className="px-4 py-4 align-top">
                <TextContent
                  textWithMarkers={original.textWithMarkers}
                  references={original.references}
                  annotations={original.annotations}
                  className="text-gray-700 dark:text-gray-300"
                  mainRef={originalMainRef}
                  offsetTopPx={offsets.left}
                />
              </td>

              {/* right column (In hedendaagse taal) */}
              <td className="px-4 py-4 align-top">
                <TextContent
                  textWithMarkers={final.textWithMarkers}
                  references={final.references}
                  annotations={final.annotations}
                  className="text-gray-900 dark:text-gray-100 font-bold"
                  mainRef={finalMainRef}
                  offsetTopPx={offsets.right}
                />
              </td>

              {/* source text + rating */}
              <td className="px-4 py-4 align-top">
                <p
                  className={`${isGreek ? 'greek-text' : 'hebrew-text'} text-gray-400 dark:text-gray-500`}
                  style={{ fontFamily: "'Frank Ruhl Libre', 'SBL Hebrew', serif" }}
                >
                  {verse.source_text}
                </p>
                <FeedbackControls
                  ratingData={ratingData}
                  onRatingChange={handleRatingChange}
                  onCommentChange={handleCommentChange}
                  className="mt-4"
                />
              </td>
            </tr>
          );
        };

        /* ================= Main App ================= */

        const App = () => {
          const [bibleData, setBibleData] = useState(null);
          const [ratings, setRatings] = useState({});
          const [introductionRating, setIntroductionRating] = useState({ rating: null, comment: '' });
          const [epilogueRating, setEpilogueRating] = useState({ rating: null, comment: '' });
          const [fileName, setFileName] = useState(null);
          const [currentBook, setCurrentBook] = useState('1JN');
          const [currentChapter, setCurrentChapter] = useState(1);
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState(null);
          const [darkMode, setDarkMode] = useState(() => {
            const saved = localStorage.getItem('darkMode');
            return saved ? JSON.parse(saved) : true;
          });

          useEffect(() => {
            if (darkMode) {
              document.documentElement.classList.add('dark');
            } else {
              document.documentElement.classList.remove('dark');
            }
            localStorage.setItem('darkMode', JSON.stringify(darkMode));
          }, [darkMode]);

          const toggleDarkMode = useCallback(() => {
            setDarkMode(prev => !prev);
          }, []);

          const loadChapter = useCallback(async (bookAbbr, chapter) => {
            setLoading(true);
            setError(null);
            const filePath = `inputs/${bookAbbr}/${bookAbbr}.${chapter}.json`;

            try {
              const response = await fetch(filePath);
              if (!response.ok) {
                throw new Error(`Bestand niet gevonden: ${filePath}`);
              }
              const data = await response.json();
              if (data && data.metadata && data.verses) {
                setBibleData(data);
                setFileName(filePath);
                setCurrentBook(bookAbbr);
                setCurrentChapter(chapter);
                setRatings({});
                setIntroductionRating({ rating: null, comment: '' });
                setEpilogueRating({ rating: null, comment: '' });
              } else {
                throw new Error("Onverwachte bestandsstructuur");
              }
            } catch (err) {
              console.error("Fout bij het laden:", err);
              setError(`Kon ${filePath} niet laden. Controleer of het bestand bestaat.`);
              setBibleData(null);
            } finally {
              setLoading(false);
            }
          }, []);

          // Load default chapter on mount (1 John 1)
          useEffect(() => {
            loadChapter('1JN', 1);
          }, [loadChapter]);

          const handleFileUpload = useCallback((data) => {
            if (data && data.metadata && data.verses) {
              setBibleData(data);
              setRatings({});
              setIntroductionRating({ rating: null, comment: '' });
              setEpilogueRating({ rating: null, comment: '' });
              setError(null);
            } else {
              alert("Het geüploade bestand heeft niet de verwachte structuur.");
            }
          }, []);

          const handleLoadNew = useCallback(() => {
            const hasVerseRatings = Object.keys(ratings).length > 0 && Object.values(ratings).some(r => r.rating || r.comment);
            const hasIntroRating = introductionRating.rating || introductionRating.comment;
            const hasEpilogueRating = epilogueRating.rating || epilogueRating.comment;

            if (hasVerseRatings || hasIntroRating || hasEpilogueRating) {
              if (!confirm("Je hebt beoordelingen die niet zijn opgeslagen. Weet je zeker dat je een nieuw bestand wilt laden?")) {
                return;
              }
            }
            setBibleData(null);
            setRatings({});
            setIntroductionRating({ rating: null, comment: '' });
            setEpilogueRating({ rating: null, comment: '' });
            setFileName(null);
            setError(null);
          }, [ratings, introductionRating, epilogueRating]);

          const handleRate = useCallback((verseNumber, rating, comment) => {
            setRatings(prevRatings => ({
              ...prevRatings,
              [verseNumber]: { rating, comment },
            }));
          }, []);

          const handleIntroductionRate = useCallback((rating, comment) => {
            setIntroductionRating({ rating, comment });
          }, []);

          const handleEpilogueRate = useCallback((rating, comment) => {
            setEpilogueRating({ rating, comment });
          }, []);

          const handleDownload = useCallback(() => {
            if (!bibleData) {
              alert("Geen beoordelingen om te downloaden.");
              return;
            }

            const ratingsToDownload = Object.entries(ratings)
              .filter(([, value]) => value.rating || value.comment)
              .reduce((obj, [key, value]) => {
                obj[Number(key)] = value;
                return obj;
              }, {});

            const hasVerseRatings = Object.keys(ratingsToDownload).length > 0;
            const hasIntroRating = introductionRating.rating || introductionRating.comment;
            const hasEpilogueRating = epilogueRating.rating || epilogueRating.comment;

            if (!hasVerseRatings && !hasIntroRating && !hasEpilogueRating) {
              alert("Geen beoordelingen of opmerkingen ingevuld om te downloaden.");
              return;
            }

            const downloadData = {
              metadata: {
                book: bibleData.metadata.book,
                chapter: bibleData.metadata.chapter,
                rated_at: new Date().toISOString(),
              },
              ratings: ratingsToDownload,
            };

            if (hasIntroRating) {
              downloadData.introduction_rating = {
                rating: introductionRating.rating,
                comment: introductionRating.comment,
              };
            }

            if (hasEpilogueRating) {
              downloadData.epilogue_rating = {
                rating: epilogueRating.rating,
                comment: epilogueRating.comment,
              };
            }

            const jsonString = JSON.stringify(downloadData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${bibleData.metadata.book_code || currentBook}_${bibleData.metadata.chapter}_beoordelingen.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }, [bibleData, ratings, introductionRating, epilogueRating, currentBook]);

          const hasRatings = Object.values(ratings).some(
            r => r.rating !== null || r.comment !== ''
          ) || introductionRating.rating || introductionRating.comment || epilogueRating.rating || epilogueRating.comment;

          return (
            <div className="min-h-screen bg-gray-100 dark:bg-gray-900">
              <Header
                fileName={fileName}
                onDownload={handleDownload}
                hasRatings={hasRatings}
                onLoadNew={handleLoadNew}
                onLoadBookChapter={loadChapter}
                currentBook={currentBook}
                currentChapter={currentChapter}
                loading={loading}
                darkMode={darkMode}
                toggleDarkMode={toggleDarkMode}
              />
              <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                {error && (
                  <div className="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-red-700 dark:text-red-300">
                    <p className="font-medium">{error}</p>
                    <div className="mt-4">
                      <FileUpload
                        onFileUpload={handleFileUpload}
                        setFileName={setFileName}
                      />
                    </div>
                  </div>
                )}

                {loading && (
                  <div className="text-center py-12">
                    <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-sky-600 dark:border-sky-400 border-t-transparent"></div>
                    <p className="mt-4 text-gray-600 dark:text-gray-400">Laden...</p>
                  </div>
                )}

                {!loading && !error && !bibleData && (
                  <div className="text-center">
                    <h2 className="text-3xl font-extrabold text-gray-900 dark:text-gray-100 sm:text-4xl mb-4">
                      Welkom
                    </h2>
                    <p className="mt-4 text-lg text-gray-600 dark:text-gray-400 mb-8">
                      Kies een bijbelboek en hoofdstuk hierboven, of upload een JSON-bestand om de vertalingen te vergelijken en te beoordelen.
                    </p>
                    <FileUpload
                      onFileUpload={handleFileUpload}
                      setFileName={setFileName}
                    />
                  </div>
                )}

                {!loading && !error && bibleData && (
                  <div>
                    <div className="mb-8 p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
                      <div className="text-center">
                        <h2 className="text-4xl font-bold text-gray-900 dark:text-gray-100">
                          {bibleData.metadata.book} {bibleData.metadata.chapter}
                        </h2>
                        <p className="mt-2 text-md text-gray-500 dark:text-gray-400">
                          {bibleData.metadata.translation_policy}
                        </p>
                      </div>

                      {(bibleData.introduction?.original ||
                        bibleData.introduction?.final) && (
                        <div className="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                          <h3 className="text-center text-lg font-semibold text-gray-700 dark:text-gray-300 mb-4">
                            Inleiding
                          </h3>
                          <div className="grid md:grid-cols-2 gap-x-8">
                            <div>
                              <h4 className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">
                                Statenvertaling 1657
                              </h4>
                              <p
                                className="intro-text text-base text-gray-700 dark:text-gray-300"
                                style={{
                                  fontFamily: "'Libre Baskerville', Georgia, serif",
                                  lineHeight: 1.6,
                                }}
                              >
                                {bibleData.introduction.original}
                              </p>
                            </div>
                            <div>
                              <h4 className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">
                                In hedendaagse taal
                              </h4>
                              <p
                                className="intro-text text-base font-bold text-gray-900 dark:text-gray-100"
                                style={{
                                  fontFamily: "'Libre Baskerville', Georgia, serif",
                                  lineHeight: 1.6,
                                }}
                              >
                                {bibleData.introduction.final}
                              </p>
                            </div>
                          </div>
                          <div className="mt-4 pt-4 border-t border-gray-100 dark:border-gray-700">
                            <h4 className="text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Beoordeling</h4>
                            <FeedbackControls
                              ratingData={introductionRating}
                              onRatingChange={(rating) => handleIntroductionRate(rating, introductionRating.comment)}
                              onCommentChange={(e) => handleIntroductionRate(introductionRating.rating, e.target.value)}
                            />
                          </div>
                        </div>
                      )}
                    </div>

                    <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden">
                      <div className="overflow-x-auto">
                        <table className="min-w-full">
                          <thead className="bg-gray-50 dark:bg-gray-900">
                            <tr>
                              <th
                                scope="col"
                                className="w-16 px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
                              >
                                Vers
                              </th>
                              <th
                                scope="col"
                                className="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
                              >
                                Statenvertaling 1657
                              </th>
                              <th
                                scope="col"
                                className="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
                              >
                                In hedendaagse taal
                              </th>
                              <th
                                scope="col"
                                className="w-64 px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
                              >
                                Brontekst ({bibleData.metadata.source_language})
                              </th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
                            {bibleData.verses.map((verse) => (
                              <VerseDisplay
                                key={verse.verse_number}
                                verse={verse}
                                ratingData={ratings[verse.verse_number]}
                                onRate={handleRate}
                                sourceLanguage={bibleData.metadata.source_language}
                              />
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>

                    {(bibleData.epilogue?.original ||
                      bibleData.epilogue?.final) && (
                      <div className="mt-8 p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
                        <h3 className="text-center text-lg font-semibold text-gray-700 dark:text-gray-300 mb-4">
                          Nawoord
                        </h3>
                        <div className="grid md:grid-cols-2 gap-x-8">
                          <div>
                            <h4 className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">
                              Statenvertaling 1657
                            </h4>
                            <p
                              className="epilogue-text text-base text-gray-700 dark:text-gray-300"
                              style={{
                                fontFamily: "'Libre Baskerville', Georgia, serif",
                                lineHeight: 1.6,
                              }}
                            >
                              {bibleData.epilogue.original}
                            </p>
                          </div>
                          <div>
                            <h4 className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">
                              In hedendaagse taal
                            </h4>
                            <p
                              className="epilogue-text text-base font-bold text-gray-900 dark:text-gray-100"
                              style={{
                                fontFamily: "'Libre Baskerville', Georgia, serif",
                                lineHeight: 1.6,
                              }}
                            >
                              {bibleData.epilogue.final}
                            </p>
                          </div>
                        </div>
                        <div className="mt-4 pt-4 border-t border-gray-100 dark:border-gray-700">
                          <h4 className="text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Beoordeling</h4>
                          <FeedbackControls
                            ratingData={epilogueRating}
                            onRatingChange={(rating) => handleEpilogueRate(rating, epilogueRating.comment)}
                            onCommentChange={(e) => handleEpilogueRate(epilogueRating.rating, e.target.value)}
                          />
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </main>
            </div>
          );
        };

        /* ================= Render ================= */

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
